<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Atendimento - Agente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
body {
    background: #f0f2f5;
}

/* √Årea do chat */
#chat {
    background: #e5ddd5;
    padding: 12px;
}

/* Mensagem base */
.msg {
    max-width: 70%;
    padding: 8px 10px;
    border-radius: 8px;
    margin-bottom: 10px;
    word-wrap: break-word;
}

/* Cliente (esquerda) */
.msg-cliente {
    background: #ffffff;
    border-top-left-radius: 0;
}

/* Agente (direita) */
.msg-agente {
    background: #dcf8c6;
    border-top-right-radius: 0;
    margin-left: auto;
}

/* Conte√∫do */
.chat-conteudo {
    font-size: 14px;
}

/* Hora */
.msg-time {
    font-size: 11px;
    color: #666;
    text-align: right;
    margin-top: 4px;
}

/* M√≠dias */
audio, img, video {
    max-width: 100%;
    border-radius: 6px;
}
</style>

</head>

<body class="bg-light">

<div class="container-fluid mt-4 px-4">


    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Atendimento</h3>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>

    <div class="alert alert-info" id="status">
        <strong>Status:</strong> Aguardando atendimento...
    </div>

    <div id="indicadorMensagens" class="alert alert-warning d-none mt-2"></div>

    <div class="card">
        <div class="card-header">Conversa Atual</div>

       
        <div class="card-body d-flex flex-column" id="chat"
           style="height:60vh; overflow-y:auto;">

            <div class="text-muted">Nenhuma mensagem ainda.</div>
        </div>

        <div class="card-footer d-flex">
            <input id="mensagem" class="form-control me-2" placeholder="Digite sua mensagem..." disabled>
            <button class="btn btn-primary" onclick="enviarMensagem()">Enviar</button>
        </div>
    </div>

    <button id="btnFinalizar" class="btn btn-danger mt-3 d-none">
        Finalizar atendimento
    </button>


<button class="btn btn-warning btn-sm me-2" onclick="abrirTransferencia()">
    üîÅ Transferir
</button>
</div>

<div class="modal fade" id="modalTransferir" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Transferir Atendimento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <label>Selecione o agente</label>
        <select id="selectAgente" class="form-control"></select>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmarTransferencia()">
          Transferir
        </button>
      </div>

    </div>
  </div>
</div>


<script src="/js/auth.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
requireRole("AGENTE");

const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");
if (!token) window.location.href = "/login.html";

/* ==========================
   ESTADO GLOBAL
========================== */
let atendimentoAtualId = null;
let atendimentoAnteriorId = null;
let numeroClienteAtual = null;
let aguardandoAtendimento = true;

let ultimaMensagemId = 0;
let mensagensNaoLidas = 0;

const chatEl = document.getElementById("chat");
const statusEl = document.getElementById("status");
const btnFinalizar = document.getElementById("btnFinalizar");
const inputMensagem = document.getElementById("mensagem");
const indicadorMensagens = document.getElementById("indicadorMensagens");

/* ==========================
   FORMATA DATA BRASIL
========================== */
function formatarDataBrasil(data) {
    if (!data) return "";

    try {
        let iso;

        // Se j√° for ISO
        if (data.includes("T")) {
            iso = data;
        }
        // Se vier "YYYY-MM-DD HH:MM:SS"
        else if (data.includes("-") && data.includes(":")) {
            iso = data.replace(" ", "T") + "Z";
        }
        // Se vier "DD/MM/YYYY HH:MM"
        else if (data.includes("/")) {
            const [d, h] = data.split(" ");
            const [dia, mes, ano] = d.split("/");
            iso = `${ano}-${mes}-${dia}T${h}:00Z`;
        }
        else {
            return data; // fallback seguro
        }

        const dateObj = new Date(iso);

        if (isNaN(dateObj.getTime())) return data;

        return dateObj.toLocaleString("pt-BR", {
            timeZone: "America/Sao_Paulo",
            hour12: false
        });

    } catch (e) {
        console.error("Erro ao formatar data:", data, e);
        return data;
    }
}


/* ==========================
   HEARTBEAT
========================== */
async function sendPing() {
    try {
        await fetch(`${API}/agente/ping`, {
            method: "POST",
            headers: { "Authorization": "Bearer " + token }
        });
    } catch {}
}

function startHeartbeat() {
    sendPing();
    setInterval(sendPing, 5000);
}

/* ==========================
   ATENDIMENTO ATUAL
========================== */
async function carregarAtendimentoAtual() {
    try {
        const res = await fetch(`${API}/agente/atual`, {
            headers: { "Authorization": "Bearer " + token }
        });

        if (res.status === 404) {
            if (!aguardandoAtendimento) limparAtendimento();
            aguardandoAtendimento = true;
            return;
        }

        if (!res.ok) return;

        const dados = await res.json();
        aguardandoAtendimento = false;

        if (atendimentoAnteriorId !== dados.id) {
            atendimentoAnteriorId = dados.id;
            atendimentoAtualId = dados.id;
            numeroClienteAtual = dados.numero;
            ultimaMensagemId = 0;
            mensagensNaoLidas = 0;
            chatEl.innerHTML = "";
        }

        statusEl.innerHTML =
            statusEl.innerHTML = `
    <strong>Empresa:</strong> ${dados.empresa}<br>
    <strong>Cliente:</strong> ${dados.cliente}<br>
    <small class="text-muted">
        N√∫mero da empresa: ${dados.empresa_numero}
    </small>
`;
statusEl.innerHTML = `
    <strong>Empresa:</strong> ${dados.empresa}<br>
    <strong>Cliente:</strong> ${dados.cliente}<br>
    <small class="text-muted">
        N√∫mero da empresa: ${dados.empresa_numero}
    </small>
`;


        btnFinalizar.classList.remove("d-none");
        inputMensagem.disabled = false;

        carregarMensagens();

    } catch (e) {
        console.error(e);
    }
}

function limparAtendimento() {
    atendimentoAtualId = null;
    atendimentoAnteriorId = null;
    numeroClienteAtual = null;
    ultimaMensagemId = 0;
    mensagensNaoLidas = 0;

    statusEl.innerHTML =
        "<strong>Status:</strong> Aguardando atendimento...";

    chatEl.innerHTML =
        `<div class="text-muted">Nenhuma mensagem ainda.</div>`;

    btnFinalizar.classList.add("d-none");
    inputMensagem.disabled = true;
    indicadorMensagens.classList.add("d-none");
}


function usuarioEstaNoFinal() {
    return chatEl.scrollHeight - chatEl.scrollTop <= chatEl.clientHeight + 50;
}


/* ==========================
   MENSAGENS
========================== */
async function carregarMensagens() {
    if (!atendimentoAtualId) return;

    const res = await fetch(
        `${API}/agente/mensagens/${atendimentoAtualId}`,
        { headers: { "Authorization": "Bearer " + token } }
    );

    if (!res.ok) return;
    const mensagens = await res.json();

    if (ultimaMensagemId === 0) {
        chatEl.innerHTML = "";
        mensagens.forEach(m => {
            renderMensagem(m, false);
            ultimaMensagemId = m.id;
        });
        chatEl.scrollTop = chatEl.scrollHeight;
        return;
    }

    const estavaNoFinal = usuarioEstaNoFinal();

mensagens.forEach(m => {
    if (m.id > ultimaMensagemId) {
        mensagensNaoLidas++;
        renderMensagem(m, true);
        ultimaMensagemId = m.id;
    }
});

if (mensagensNaoLidas > 0 && estavaNoFinal) {
    chatEl.scrollTop = chatEl.scrollHeight;
}

atualizarIndicador();

}

function renderMensagem(m, destaque) {
    const lado = m.remetente === "AGENTE" ? "msg-agente" : "msg-cliente";
    let conteudo = "";

    if (m.tipo === "AUDIO") {
        conteudo = `
            <audio controls>
                <source src="${API}/media/twilio/view?url=${encodeURIComponent(m.arquivo_url)}">
            </audio>`;
    }
    else if (m.tipo === "IMAGEM") {
        conteudo = `
            <img src="${API}/media/twilio/view?url=${encodeURIComponent(m.arquivo_url)}">`;
    }
    else if (m.tipo === "VIDEO") {
        conteudo = `
            <video controls>
                <source src="${API}/media/twilio/view?url=${encodeURIComponent(m.arquivo_url)}">
            </video>`;
    }
    else if (m.arquivo_url) {
        conteudo = `
            <a href="${API}/media/twilio/view?url=${encodeURIComponent(m.arquivo_url)}"
               target="_blank"
               class="btn btn-outline-secondary btn-sm">
               üìÑ Abrir documento
            </a>`;
    }
    else {
        conteudo = `<span>${m.conteudo || ""}</span>`;
    }

    chatEl.innerHTML += `
        <div class="msg ${lado}">
            <div class="chat-conteudo">${conteudo}</div>
            <div class="msg-time">${formatarDataBrasil(m.criada_em)}</div>
        </div>
    `;
}


/* ==========================
   ENVIAR
========================== */
async function enviarMensagem() {
    const texto = inputMensagem.value.trim();
    if (!texto || !atendimentoAtualId) return;

    inputMensagem.disabled = true;

    await fetch(`${API}/agente/mensagem`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            atendimento_id: atendimentoAtualId,
            mensagem: texto,
            numero_cliente: numeroClienteAtual
        })
    });

    inputMensagem.value = "";
    inputMensagem.disabled = false;
    carregarMensagens();
}

/* ==========================
   FINALIZAR
========================== */
btnFinalizar.onclick = async () => {
    if (!confirm("Finalizar atendimento?")) return;

    await fetch(`${API}/agente/finalizar/${atendimentoAtualId}`, {
        method: "PUT",
        headers: { "Authorization": "Bearer " + token }
    });

    limparAtendimento();
};

/* ==========================
   INIT
========================== */
document.addEventListener("DOMContentLoaded", () => {
    startHeartbeat();
    carregarAtendimentoAtual();
    setInterval(carregarAtendimentoAtual, 3000);
});


let modalTransferir = null;

async function abrirTransferencia() {
    const res = await fetch(`${API}/agente/online`, {
        headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    const select = document.getElementById("selectAgente");
    select.innerHTML = "";

    data.agentes.forEach(a => {
        select.innerHTML += `<option value="${a.id}">${a.nome}</option>`;
    });

    modalTransferir = new bootstrap.Modal(
        document.getElementById("modalTransferir")
    );
    modalTransferir.show();
}

async function confirmarTransferencia() {
    const agenteDestino = document.getElementById("selectAgente").value;

    if (!agenteDestino) {
        alert("Selecione um agente");
        return;
    }

    const res = await fetch(`${API}/agente/transferir`, {
        method: "POST",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
            atendimento_id: atendimentoAtualId,
            novo_agente_id: agenteDestino
        })
    });

    if (res.ok) {
        alert("Atendimento transferido com sucesso!");
        modalTransferir.hide();
        limparAtendimento();
    } else {
        const erro = await res.json();
        alert(erro.erro || "Erro ao transferir atendimento");
    }
}

</script>

</body>
</html>
