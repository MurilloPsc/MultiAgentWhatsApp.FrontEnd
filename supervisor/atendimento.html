<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Atendimento - Supervisor</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
.chat-conteudo {
  font-weight: normal;
}
audio, img, video {
  max-width: 300px;
}
</style>
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
  <span class="navbar-brand">Atendimento do Supervisor</span>
  <button class="btn btn-outline-light btn-sm" onclick="logout()">Sair</button>
</nav>

<div class="container mt-4">

<a href="andamento.html" class="btn btn-outline-secondary btn-sm mb-3">
  ‚Üê Voltar para atendimentos
</a>

<div class="card">
  <div class="card-header">
    <strong>Conversa</strong>
  </div>

  <div class="card-body" id="chat" style="height:350px; overflow-y:auto;">
    <div class="text-muted">Carregando mensagens...</div>
  </div>
</div>

</div>

<script src="/js/auth.js"></script>

<script>
requireRole("SUPERVISOR");

const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");
if (!token) window.location.href = "/login.html";

const chatEl = document.getElementById("chat");
const params = new URLSearchParams(window.location.search);
const atendimentoId = params.get("id");

/* =========================
   CARREGAR MENSAGENS
========================= */
async function carregarMensagens() {
  if (!atendimentoId) return;

  const res = await fetch(
    `${API}/supervisor/mensagens/${atendimentoId}`,
    { headers: { "Authorization": "Bearer " + token } }
  );

  if (!res.ok) {
    chatEl.innerHTML = "<div class='text-danger'>Erro ao carregar mensagens</div>";
    return;
  }

  const mensagens = await res.json();
  chatEl.innerHTML = "";

  mensagens.forEach(m => renderMensagem(m));
  chatEl.scrollTop = chatEl.scrollHeight;
}

/* =========================
   RENDER
========================= */
function renderMensagem(m) {
  let conteudo = "";
  const mediaUrl = m.arquivo_url
    ? `${API}/media/twilio?url=${encodeURIComponent(m.arquivo_url)}`
    : null;

  if (m.tipo === "AUDIO") {
    conteudo = `
      <audio controls>
        <source src="${mediaUrl}">
      </audio>`;
  }
  else if (m.tipo === "IMAGEM") {
    conteudo = `
      <img src="${mediaUrl}" class="img-thumbnail">`;
  }
  else if (m.tipo === "VIDEO") {
    conteudo = `
      <video controls>
        <source src="${mediaUrl}">
      </video>`;
  }
  else if (m.arquivo_url) {
    let icon = "üìé";
    let label = "Baixar arquivo";

    const u = m.arquivo_url.toLowerCase();
    if (u.endsWith(".pdf")) { icon="üìÑ"; label="Baixar PDF"; }
    else if (u.endsWith(".doc") || u.endsWith(".docx")) { icon="üìù"; label="Baixar Word"; }
    else if (u.endsWith(".xls") || u.endsWith(".xlsx")) { icon="üìä"; label="Baixar Excel"; }
    else if (u.endsWith(".zip") || u.endsWith(".rar")) { icon="üóúÔ∏è"; label="Baixar ZIP"; }

    conteudo = `
      <a href="${mediaUrl}" class="btn btn-outline-primary btn-sm" target="_blank">
        ${icon} ${label}
      </a>`;
  }
  else {
    conteudo = `<span>${m.conteudo || ""}</span>`;
  }

  chatEl.innerHTML += `
    <div class="mb-2 p-2 rounded bg-white shadow-sm">
      <div><strong>${m.remetente}:</strong></div>
      <div class="mt-1 chat-conteudo">${conteudo}</div>
      <div class="text-muted small mt-1">${m.data || ""}</div>
    </div>`;
}

/* =========================
   INIT
========================= */
document.addEventListener("DOMContentLoaded", carregarMensagens);
</script>

</body>
</html>
