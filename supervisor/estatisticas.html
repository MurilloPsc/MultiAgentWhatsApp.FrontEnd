<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Estat√≠sticas - Supervisor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>üìà Estat√≠sticas</h3>
        <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>

    <!-- FILTROS -->
    <div class="card mb-3">
        <div class="card-body d-flex gap-3 flex-wrap">

            <div>
                <label class="form-label">M√™s</label>
                <select id="mes" class="form-select">
                    <option value="1">Jan</option>
                    <option value="2">Fev</option>
                    <option value="3">Mar</option>
                    <option value="4">Abr</option>
                    <option value="5">Mai</option>
                    <option value="6">Jun</option>
                    <option value="7">Jul</option>
                    <option value="8">Ago</option>
                    <option value="9">Set</option>
                    <option value="10">Out</option>
                    <option value="11">Nov</option>
                    <option value="12">Dez</option>
                </select>
            </div>

            <div>
                <label class="form-label">Ano</label>
                <select id="ano" class="form-select">
                    <option>2024</option>
                    <option>2025</option>
                    <option selected>2026</option>
                </select>
            </div>

            <div class="align-self-end">
                <button class="btn btn-primary" onclick="carregarDashboard()">
                    üîÑ Atualizar
                </button>
            </div>

        </div>
    </div>

    <!-- KPI -->
    <div class="alert alert-info">
        ‚è± Tempo m√©dio de atendimento: <strong><span id="tempoMedio">0</span> min</strong>
    </div>

    <!-- GR√ÅFICOS -->
    <div class="row g-3">
        <div class="col-md-6">
            <div class="card p-3">
                <h6>Atendimentos por Agente</h6>
                <canvas id="graficoAgentes"></canvas>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card p-3">
                <h6>Atendimentos por Dia</h6>
                <canvas id="graficoDias"></canvas>
            </div>
        </div>
    </div>

</div>

<script src="/js/auth.js"></script>

<script>
requireRole("SUPERVISOR");

const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");
const empresaId = JSON.parse(atob(token.split(".")[1])).empresa_id;

let chartAgentes = null;
let chartDias = null;

async function carregarDashboard() {
    const mes = document.getElementById("mes").value;
    const ano = document.getElementById("ano").value;

    const res = await fetch(
        `${API}/supervisor/dashboard/${empresaId}?mes=${mes}&ano=${ano}`,
        { headers: { "Authorization": "Bearer " + token } }
    );

    if (!res.ok) return;

    const dados = await res.json();

    document.getElementById("tempoMedio").innerText = dados.tempo_medio;

    // üîπ Gr√°fico por agente
    const nomes = dados.por_agente.map(a => a.nome);
    const totais = dados.por_agente.map(a => a.total);

    if (chartAgentes) chartAgentes.destroy();
    chartAgentes = new Chart(
        document.getElementById("graficoAgentes"),
        {
            type: "bar",
            data: {
                labels: nomes,
                datasets: [{
                    label: "Atendimentos",
                    data: totais
                }]
            }
        }
    );

    // üîπ Gr√°fico por dia
    const dias = dados.por_dia.map(d => d.dia);
    const totaisDia = dados.por_dia.map(d => d.total);

    if (chartDias) chartDias.destroy();
    chartDias = new Chart(
        document.getElementById("graficoDias"),
        {
            type: "line",
            data: {
                labels: dias,
                datasets: [{
                    label: "Atendimentos",
                    data: totaisDia
                }]
            }
        }
    );
}
</script>

</body>
</html>
