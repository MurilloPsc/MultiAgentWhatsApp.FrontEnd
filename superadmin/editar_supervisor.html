<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editar Supervisor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4">
    <h3>Editar Supervisor</h3>

    <a href="javascript:history.back()" class="btn btn-secondary mb-3">← Voltar</a>

    <form id="formEditar">
        <div class="mb-2">
            <label>Nome</label>
            <input id="nome" class="form-control" required>
        </div>

        <div class="mb-2">
            <label>Email</label>
            <input id="email" type="email" class="form-control" required>
        </div>

        <div class="mb-3">
            <label>Nova senha (opcional)</label>
            <input id="senha" type="password" class="form-control">
        </div>

        <button class="btn btn-primary">Salvar</button>
    </form>

    <div id="msg" class="mt-3"></div>
</div>

<script>
const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");
if (!token) window.location.href = "/login.html";

const params = new URLSearchParams(window.location.search);
const supervisorId = params.get("id");

async function carregarSupervisor() {
    const resp = await fetch(`${API}/usuarios/${supervisorId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    if (!resp.ok) {
        alert("Erro ao carregar supervisor");
        return;
    }

    const supervisor = await resp.json();

    if (supervisor.role !== "SUPERVISOR") {
        alert("Usuário não é supervisor");
        return;
    }

    document.getElementById("nome").value = supervisor.nome;
    document.getElementById("email").value = supervisor.email;
}


document.getElementById("formEditar").addEventListener("submit", async e => {
    e.preventDefault();

    const dados = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value
    };

    const senha = document.getElementById("senha").value;
    if (senha) dados.senha = senha;

    const resp = await fetch(`${API}/usuarios/${supervisorId}`, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(dados)
    });

    const msg = document.getElementById("msg");

    if (resp.ok) {
        msg.className = "text-success";
        msg.innerText = "Supervisor atualizado com sucesso";
    } else {
        const r = await resp.json();
        msg.className = "text-danger";
        msg.innerText = r.erro || "Erro ao atualizar supervisor";
    }
});

carregarSupervisor();
</script>

</body>
</html>
