<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agentes da Empresa</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
  <span class="navbar-brand">SuperAdmin • Agentes</span>
  <button class="btn btn-outline-light btn-sm" onclick="logout()">Sair</button>
</nav>

<div class="container mt-4">

<h4>Agentes da Empresa</h4>

<a href="/superadmin/empresas.html" class="btn btn-secondary btn-sm mb-3">
  ← Voltar para Empresas
</a>

<table class="table table-striped">
<thead class="table-dark">
<tr>
  <th>Nome</th>
  <th>Email</th>
  <th>Status</th>
  <th width="220">Ações</th>
</tr>
</thead>

<tbody id="listaAgentes">
<tr>
  <td colspan="4" class="text-center text-muted">
    Carregando agentes...
  </td>
</tr>
</tbody>
</table>

</div>

<script src="/js/auth.js"></script>

<script>
requireRole("SUPERADMIN");

const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");
if (!token) window.location.href = "/login.html";

const params = new URLSearchParams(window.location.search);
const empresaId = params.get("empresa_id");

if (!empresaId) {
    alert("Empresa não informada");
    window.location.href = "/superadmin/empresas.html";
}

// =======================
// CARREGAR AGENTES
// =======================
async function carregarAgentes() {

    const res = await fetch(`${API}/usuarios/agentes/${empresaId}`, {
        headers: { "Authorization": "Bearer " + token }
    });

    if (!res.ok) {
        alert("Erro ao carregar agentes");
        return;
    }

    const data = await res.json();
    const tbody = document.getElementById("listaAgentes");
    tbody.innerHTML = "";

    if (!data.agentes.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted">
              Nenhum agente cadastrado
            </td>
          </tr>`;
        return;
    }

    data.agentes.forEach(a => {
        tbody.innerHTML += `
        <tr>
          <td>${a.nome}</td>
          <td>${a.email}</td>
          <td>
            <span class="badge ${a.status === "ONLINE" ? "bg-success" : "bg-secondary"}">
              ${a.status || "OFFLINE"}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-warning"
              onclick="editarAgente(${a.id})">
              Editar
            </button>

            <button class="btn btn-sm btn-danger"
              onclick="excluirAgente(${a.id})">
              Excluir
            </button>
          </td>
        </tr>`;
    });
}

// =======================
// EXCLUIR
// =======================
async function excluirAgente(id) {
    if (!confirm("Deseja excluir este agente?")) return;

    const res = await fetch(`${API}/usuarios/${id}`, {
        method: "DELETE",
        headers: { "Authorization": "Bearer " + token }
    });

    if (res.ok) {
        carregarAgentes();
    } else {
        alert("Erro ao excluir agente");
    }
}

// =======================
// EDITAR
// =======================
function editarAgente(id) {
    window.location.href =
      `/superadmin/editar_agente.html?id=${id}&empresa_id=${empresaId}`;
}

carregarAgentes();
</script>

</body>
</html>

