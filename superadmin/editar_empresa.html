<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editar Empresa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2>Editar Empresa</h2>
    <a href="/superadmin/empresas.html" class="btn btn-secondary mb-3">← Voltar</a>

    <form id="formEditar">
        <input type="hidden" id="empresaId">

        <label class="form-label">Nome</label>
        <input id="nome" class="form-control mb-2">

        <label class="form-label">CNPJ</label>
        <input id="cnpj" class="form-control mb-2">

        <label class="form-label">Telefone</label>
        <input id="telefone" class="form-control mb-2">

        <label class="form-label">Email</label>
        <input id="email" class="form-control mb-2">
      
        <label class="form-label">Whatsapp_from</label>
        <input id="whatsapp_from" class="form-control mb-2">
       
        <label class="form-label">Messaging Service SID (Twilio)</label>
       <input id="messaging_service_sid" class="form-control mb-2" placeholder="Ex: MGf64bc47740ea24950ccba3da2a43a551">
       <small class="text-muted">
        SID do Messaging Service no Twilio (começa com <b>MG</b>)
       </small>


        <label class="form-label">Status</label>
        <select id="status" class="form-control mb-2">
            <option value="ATIVA">Ativa</option>
            <option value="INATIVA">Inativa</option>
        </select>

        <label class="form-label">Plano</label>
        <select id="plano" class="form-control mb-3"></select>

        <button class="btn btn-primary" type="submit">Salvar Alterações</button>
    </form>

    <p id="msg" class="mt-3 text-success"></p>
</div>

<script>
const API = "https://api.all-multiagente.com.br";

// ------------------------------------------------
// Capturar ID da empresa pela URL
// ------------------------------------------------
const params = new URLSearchParams(window.location.search);
const empresaId = params.get("id");

if (!empresaId) {
    alert("Empresa não informada.");
}

document.getElementById("empresaId").value = empresaId;

// ------------------------------------------------
// Carregar Planos
// ------------------------------------------------
async function carregarPlanos(planoAtual = null) {
    const response = await fetch(`${API}/planos/listar`);
    const data = await response.json();

    const select = document.getElementById("plano");
    select.innerHTML = "";

    data.planos.forEach(p => {
        const selected = p.id === planoAtual ? "selected" : "";
        select.innerHTML += `
            <option value="${p.id}" ${selected}>
                ${p.nome}
            </option>
        `;
    });
}

// ------------------------------------------------
// Carregar Empresa (VERSÃO FINAL BLINDADA)
// ------------------------------------------------
async function carregarEmpresa() {
    try {
        const response = await fetch(`${API}/empresas/detalhes/${empresaId}`);
        const e = await response.json();

        document.getElementById("nome").value = e.nome || "";
        document.getElementById("cnpj").value = e.cnpj || "";
        document.getElementById("telefone").value = e.telefone || "";
        document.getElementById("email").value = e.email || "";
        document.getElementById("whatsapp_from").value = e.whatsapp_from || "";
        document.getElementById("messaging_service_sid").value =
            e.messaging_service_sid || "";

        document.getElementById("status").value = e.status || "ATIVA";

        // ⚠️ IMPORTANTE: plano NÃO pode quebrar o resto
        if (e.plano && e.plano.id) {
            carregarPlanos(e.plano.id)
                .catch(err => console.error("Erro ao carregar planos:", err));
        }

    } catch (err) {
        console.error("Erro ao carregar empresa:", err);
        alert("Erro ao carregar empresa");
    }
}


// ------------------------------------------------
// Salvar Alterações
// ------------------------------------------------
document.getElementById("formEditar").addEventListener("submit", async function(event) {
    event.preventDefault();

    const dados = {
    nome: document.getElementById("nome").value,
    cnpj: document.getElementById("cnpj").value,
    telefone: document.getElementById("telefone").value,
    email: document.getElementById("email").value,
    whatsapp_from: document.getElementById("whatsapp_from").value,
    messaging_service_sid: document.getElementById("messaging_service_sid").value,
    status: document.getElementById("status").value,
    plano_id: document.getElementById("plano").value
};




    const response = await fetch(`${API}/empresas/update/${empresaId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(dados)
    });

    const result = await response.json();
    document.getElementById("msg").innerText =
        result.message || "Alterações salvas com sucesso!";
});

// Inicialização
carregarEmpresa();
</script>

</body>
</html>
