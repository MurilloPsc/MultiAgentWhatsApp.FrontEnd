<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Supervisores - SuperAdmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2>Supervisores Cadastrados</h2>

    <a href="/superadmin/empresas.html" class="btn btn-secondary mb-3">
        ‚Üê Voltar
    </a>

    <a href="/superadmin/criar_supervisor.html" class="btn btn-primary mb-3">
        + Novo Supervisor
    </a>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
               <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Status</th>
                <th width="160">A√ß√µes</th>
             </tr>

        </thead>
        <tbody id="listaSupervisores"></tbody>
    </table>
</div>

<script>
const API = "https://api.all-multiagente.com.br";
const token = localStorage.getItem("token");

if (!token) {
    window.location.href = "/login.html";
}

// üëâ pega empresa_id da URL
const params = new URLSearchParams(window.location.search);
const empresaId = params.get("empresa_id");

if (!empresaId) {
    alert("Empresa n√£o informada");
    window.location.href = "/superadmin/empresas.html";
}

// ‚úÖ FUN√á√ÉO ASYNC (aqui estava o erro antes)
async function carregarSupervisores() {
    try {
        const resp = await fetch(
            `${API}/usuarios/supervisores/${empresaId}`,
            {
                headers: {
                    "Authorization": "Bearer " + token
                }
            }
        );

        if (!resp.ok) {
            const txt = await resp.text();
            console.error("Erro API:", resp.status, txt);
            alert("Erro ao carregar supervisores");
            return;
        }

        const data = await resp.json();
        const lista = document.getElementById("listaSupervisores");
        lista.innerHTML = "";

        if (!data.supervisores || data.supervisores.length === 0) {
            lista.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center">
                        Nenhum supervisor cadastrado
                    </td>
                </tr>
            `;
            return;
        }

        data.supervisores.forEach(s => {
    lista.innerHTML += `
        <tr>
            <td>${s.nome}</td>
            <td>${s.email}</td>
            <td>${s.status || "OFFLINE"}</td>
            <td>
                <button class="btn btn-sm btn-warning"
                    onclick="editarSupervisor(${s.id})">
                    Editar
                </button>
                <button class="btn btn-sm btn-danger"
                    onclick="excluirSupervisor(${s.id})">
                    Excluir
                </button>
            </td>
        </tr>
    `;
});


    } catch (err) {
        console.error("Exception:", err);
        alert("Erro inesperado ao carregar supervisores");
    }
}



function editarSupervisor(id) {
    window.location.href = `/superadmin/editar_supervisor.html?id=${id}`;
}

async function excluirSupervisor(id) {
    if (!confirm("Deseja realmente excluir este supervisor?")) return;

    const resp = await fetch(`${API}/usuarios/${id}`, {
        method: "DELETE",
        headers: {
            "Authorization": "Bearer " + token
        }
    });

    if (resp.ok) {
        alert("Supervisor exclu√≠do com sucesso");
        carregarSupervisores();
    } else {
        const r = await resp.json();
        alert(r.erro || "Erro ao excluir supervisor");
    }
}

// üöÄ inicia corretamente
carregarSupervisores();


</script>

</body>
</html>
