<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Editar Plano</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-4">
    <h2>Editar Plano</h2>

    <form id="formPlano">
        <input class="form-control mb-2" id="nome" placeholder="Nome do Plano">
        <textarea class="form-control mb-2" id="descricao" placeholder="Descrição"></textarea>
        <input class="form-control mb-2" id="limite_agentes" type="number" placeholder="Limite de Agentes">
        <input class="form-control mb-2" id="limite_mensagens" type="number" placeholder="Limite de Mensagens">
        <input class="form-control mb-2" id="valor" type="number" step="0.01" placeholder="Valor">

        <select id="status" class="form-control mb-3">
            <option value="ATIVO">ATIVO</option>
            <option value="INATIVO">INATIVO</option>
        </select>

        <button class="btn btn-primary" type="submit">Salvar Alterações</button>
        <a href="/superadmin/planos.html" class="btn btn-secondary">Cancelar</a>
    </form>

    <p id="msg" class="mt-3"></p>
</div>

<script>
const API = "https://api.all-multiagente.com.br";

// Obtém ID do plano da URL
const urlParams = new URLSearchParams(window.location.search);
const planoId = urlParams.get("id");

// --------------------------
// CARREGAR PLANO
// --------------------------
async function carregarPlano() {
    try {
        const resp = await fetch(`${API}/planos/buscar/${planoId}`);
        const data = await resp.json();

        if (!resp.ok) {
            alert("Erro ao carregar os dados do plano.");
            console.error(data);
            return;
        }

        // Preenchendo os campos
        document.getElementById("nome").value = data.nome || "";
        document.getElementById("descricao").value = data.descricao || "";
        document.getElementById("limite_agentes").value = data.limite_agentes || "";
        document.getElementById("limite_mensagens").value = data.limite_mensagens || "";
        document.getElementById("valor").value = data.valor || "";
        document.getElementById("status").value = data.status || "ATIVO";

    } catch (err) {
        console.error("Erro ao carregar plano:", err);
        alert("Falha inesperada ao carregar o plano.");
    }
}

// --------------------------
// SALVAR ALTERAÇÕES
// --------------------------
async function salvarPlano(event) {
    event.preventDefault();

    const dados = {
        nome: document.getElementById("nome").value,
        descricao: document.getElementById("descricao").value,
        limite_agentes: document.getElementById("limite_agentes").value,
        limite_mensagens: document.getElementById("limite_mensagens").value,
        valor: document.getElementById("valor").value,
        status: document.getElementById("status").value
    };

    const resp = await fetch(`${API}/planos/update/${planoId}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(dados)
    });

    const result = await resp.json();

    if (resp.ok) {
        document.getElementById("msg").innerHTML = "Plano atualizado com sucesso!";
    } else {
        alert("Erro ao atualizar plano: " + (result.error || "Erro desconhecido"));
    }
}

// Conecta o submit ao formulário correto
document.getElementById("formPlano").addEventListener("submit", salvarPlano);

// Carrega o plano logo que a página abre
carregarPlano();
</script>

</body>
</html>
